<!DOCTYPE html>
<html lang="en">
  <head>
    <title>InstantParty | Manage Listings</title>
    <link rel="stylesheet" href="css_files/manage_listings_style.css" />
  </head>
  <body>
    <!-- Logo -->
    <div id="logo">
      <a href="home.html">
        <img
          src="images/logo.png"
          alt="InstantParty Logo"
          class="logo-img"
          width="200"
        />
      </a>
    </div>

    <!-- Profile Dropdown -->
    <div id="profile_dropdown">
      <div class="profile" onclick="menuToggle()">
        <img src="images/profile.png" alt="Profile Picture" />
      </div>
      <div class="menu">
        <h3>Username<br /><span>Location</span></h3>
        <ul>
          <li>
            <img src="images/user.png" width="50" /><a
              href="profile_settings.html"
              >My Profile</a
            >
          </li>
          <li>
            <img src="images/settings.png" width="50" /><a href="settings.html"
              >Settings</a
            >
          </li>
          <li>
            <img src="images/inbox.png" width="50" /><a href="inbox.html"
              >Inbox</a
            >
          </li>
          <li>
            <img src="images/manage.png" width="50" /><a
              href="manage_listings.html"
              >Manage your spaces</a
            >
          </li>
          <li>
            <img src="images/balloons.png" width="50" /><a
              href="host_space.html"
              >Host your space</a
            >
          </li>
          <li>
            <img src="images/logout.png" width="50" /><a href="login.html"
              >Logout</a
            >
          </li>
        </ul>
      </div>
    </div>

    <!-- Listings Management -->
    <main id="listings_main">
      <section class="listings-section">
        <h2>Your Created Listings</h2>
        <div class="listings-grid" id="createdListings"></div>
      </section>

      <section class="listings-section reserved-listings">
        <h2>Your Reserved Listings</h2>
        <div class="listings-grid">
          <!-- Example reserved listing -->
          <div class="listing-card">
            <h3>Graduation Bash Downtown</h3>
            <p>Date: June 1, 2025</p>
            <p>Guests: 20</p>
            <button class="cancel-btn">Cancel</button>
          </div>
          <!-- Add more reserved listings here -->
        </div>
      </section>
    </main>

    <div id="editModal" class="modal" style="display: none;">
      <div class="modal-content">
        <span class="closeBtn" onclick="closeEditModal()">&times;</span>
        <h3>Edit Listing</h3>
        <form id="editListingForm">
          <input type="hidden" id="edit-id" />
          <label>Name:</label>
          <input type="text" id="edit-name" required />
          <label>Address:</label>
          <input type="text" id="edit-address" required />
          <label>Price:</label>
          <input type="number" id="edit-price" required />
          <button type="submit">Save</button>
        </form>
      </div>
    </div>

    <footer id="site_footer">
      <p>&copy; 2025 InstantParty. All rights reserved.</p>
      <div class="footer-links">
        <a href="privacy.html">Privacy</a>
        <a href="terms.html">Terms</a>
        <a href="support.html">Support</a>
      </div>
    </footer>

    <script>
      function menuToggle() {
        const toggleMenu = document.querySelector(".menu");
        toggleMenu.classList.toggle("active");
      }
    </script>

    <script>
      async function loadListings() {
        const response = await fetch('/api/listings');
        const listings = await response.json();
      
        const container = document.getElementById('createdListings');
        container.innerHTML = '';
      
        listings.forEach(listing => {
          const card = document.createElement('div');
          card.classList.add('listing-card');
          card.innerHTML = `
            <h3>${listing.name}</h3>
            <p>Address: ${listing.address}</p>
            <p>Price: $${listing.price}</p>
            <button class="editBtn" data-id="${listing._id}">Edit</button>
            <button class="deleteBtn" data-id="${listing._id}">Delete</button>
          `;
          container.appendChild(card);
        });
      
        document.querySelectorAll('.deleteBtn').forEach(button => {
          button.addEventListener('click', async () => {
            const listingId = button.getAttribute('data-id');
            const confirmed = confirm('Are you sure you want to delete this listing?');
            if (!confirmed) return;
          
            const res = await fetch(`/api/listings/${listingId}`, {
              method: 'DELETE'
            });
          
            if (res.ok) {
              alert('Listing deleted');
              loadListings();
            } else {
              alert('Error deleting listing');
            }
          });
        });

        document.querySelectorAll('.editBtn').forEach(button => {
          button.addEventListener('click', () => {
            const listingId = button.getAttribute('data-id');
            const listing = listings.find(l => l._id === listingId);
            openEditModal(listing);
          });
        });
      }
    
      function openEditModal(listing) {
        document.getElementById('edit-id').value = listing._id;
        document.getElementById('edit-name').value = listing.name;
        document.getElementById('edit-address').value = listing.address;
        document.getElementById('edit-price').value = listing.price;

        document.getElementById('editModal').style.display = 'flex';
      }

      function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
      }

      document.getElementById('editListingForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        const id = document.getElementById('edit-id').value;
        const updatedData = {
          name: document.getElementById('edit-name').value,
          address: document.getElementById('edit-address').value,
          price: document.getElementById('edit-price').value
        };

        const res = await fetch(`/api/listings/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updatedData)
        });

        if (res.ok) {
          closeEditModal();
          loadListings(); // Refresh listings
        } else {
          alert('Error updating listing.');
        }
      });

      loadListings();
    </script>
  </body>
</html>
